name: Basic linting, formatting and building

on:
  push:
    # Skip basic checks for documentation-only changes
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/CODEOWNERS'
      - '.github/FUNDING.yml'
      - 'LICENSE'
      - '.vscode/**'

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DATABASE_URL: postgresql://chatweb:password@localhost:5432/chatweb?schema=public
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TEST_DB_HOST: postgres
  TEST_DB_PORT: 5432
  TEST_DB_USER: chatweb
  TEST_DB_PASSWORD: password
  NATS_URL: nats://nats:4222
  QDRANT_URL: http://qdrant:6333
  OLLAMA_BASE_URL: ${{ secrets.OLLAMA_BASE_URL }}
  OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  MODEL_NAME_CHAT: qwen3:latest
  MODEL_NAME_VL: gemma3:latest
  MODEL_NAME_EMBEDDING: bge-m3:latest
  CRAWLER_CREDENTIALS_DIR: /tmp/crawler-credentials
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/george-ai-ci

jobs:
  calculate-smb-test-hash:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      smb_test_hash: ${{ steps.hash.outputs.smb_test }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate SMB test server hash
        id: hash
        run: |
          SMB_TEST_HASH=$(find apps/smb-test-server -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          SMB_TEST_HASH_SHORT="${SMB_TEST_HASH:0:12}"
          echo "smb_test=${SMB_TEST_HASH_SHORT}" >> $GITHUB_OUTPUT
          echo "SMB Test Server hash: ${SMB_TEST_HASH_SHORT}"

  check-smb-test-image:
    needs: calculate-smb-test-hash
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: read
      packages: read
    outputs:
      build_needed: ${{ steps.check.outputs.build_needed }}
      image_tag: ${{ steps.check.outputs.image_tag }}
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if SMB test image exists
        id: check
        env:
          SMB_TEST_HASH: ${{ needs.calculate-smb-test-hash.outputs.smb_test_hash }}
        run: |
          SMB_TEST_TAG="${{ env.IMAGE_PREFIX }}-smb-test:${SMB_TEST_HASH}"
          echo "image_tag=${SMB_TEST_TAG}" >> $GITHUB_OUTPUT

          if docker manifest inspect "${SMB_TEST_TAG}" > /dev/null 2>&1; then
            echo "✓ SMB test image exists (${SMB_TEST_HASH})"
            echo "build_needed=false" >> $GITHUB_OUTPUT
          else
            echo "✗ SMB test image needs building (${SMB_TEST_HASH})"
            echo "build_needed=true" >> $GITHUB_OUTPUT
          fi

  build-smb-test:
    needs: [calculate-smb-test-hash, check-smb-test-image]
    if: needs.check-smb-test-image.outputs.build_needed == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push SMB test server image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/smb-test-server/Dockerfile
          push: true
          tags: ${{ needs.check-smb-test-image.outputs.image_tag }}
          cache-from: type=gha,scope=smb-test
          cache-to: type=gha,mode=max,scope=smb-test

      - name: Skip SMB test build
        if: needs.check-smb-test-image.outputs.build_needed != 'true'
        run: echo "⏭️ Skipping SMB test server - image already exists"

  calculate-nats-hash:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      nats_hash: ${{ steps.hash.outputs.nats }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate NATS service hash
        id: hash
        run: |
          NATS_HASH=$(find services/nats-service -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          NATS_HASH_SHORT="${NATS_HASH:0:12}"
          echo "nats=${NATS_HASH_SHORT}" >> $GITHUB_OUTPUT
          echo "NATS Service hash: ${NATS_HASH_SHORT}"

  check-nats-image:
    needs: calculate-nats-hash
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: read
      packages: read
    outputs:
      build_needed: ${{ steps.check.outputs.build_needed }}
      image_tag: ${{ steps.check.outputs.image_tag }}
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if NATS service image exists
        id: check
        env:
          NATS_HASH: ${{ needs.calculate-nats-hash.outputs.nats_hash }}
        run: |
          NATS_TAG="${{ env.IMAGE_PREFIX }}-nats:${NATS_HASH}"
          echo "image_tag=${NATS_TAG}" >> $GITHUB_OUTPUT

          if docker manifest inspect "${NATS_TAG}" > /dev/null 2>&1; then
            echo "✓ NATS service image exists (${NATS_HASH})"
            echo "build_needed=false" >> $GITHUB_OUTPUT
          else
            echo "✗ NATS service image needs building (${NATS_HASH})"
            echo "build_needed=true" >> $GITHUB_OUTPUT
          fi

  build-nats:
    needs: [calculate-nats-hash, check-nats-image]
    if: needs.check-nats-image.outputs.build_needed == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push NATS service image
        uses: docker/build-push-action@v5
        with:
          context: services/nats-service
          file: services/nats-service/Dockerfile
          push: true
          tags: ${{ needs.check-nats-image.outputs.image_tag }}
          cache-from: type=gha,scope=nats
          cache-to: type=gha,mode=max,scope=nats

      - name: Skip NATS service build
        if: needs.check-nats-image.outputs.build_needed != 'true'
        run: echo "⏭️ Skipping NATS service - image already exists"

  eslint:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.15.4
          run_install: true
      - run: pnpm run lint

  prettier:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.15.4
          run_install: true
      - run: pnpm run format:check

  typecheck:
    runs-on: ubuntu-22.04
    services:
      postgres: &postgres_service
        image: postgres:16
        env:
          POSTGRES_DB: chatweb
          POSTGRES_USER: chatweb
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.15.4
          run_install: true
      - name: Run database migrations
        run: pnpm --filter @george-ai/app-domain prisma:migrate
      - run: pnpm run typecheck

  build:
    runs-on: ubuntu-22.04
    services:
      postgres: *postgres_service
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.4
          run_install: false
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run database migrations
        run: pnpm --filter @george-ai/app-domain prisma:migrate
      - name: Build
        run: pnpm build

  test:
    runs-on: ubuntu-22.04
    needs: [check-smb-test-image, build-smb-test, check-nats-image, build-nats]
    if: always() && needs.check-smb-test-image.result == 'success' && (needs.build-smb-test.result == 'success' || needs.build-smb-test.result == 'skipped') && needs.check-nats-image.result == 'success' && (needs.build-nats.result == 'success' || needs.build-nats.result == 'skipped')
    services:
      postgres: *postgres_service
      nats:
        image: ${{ needs.check-nats-image.outputs.image_tag }}
        credentials:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        ports:
          - 4222:4222
          - 8222:8222
      qdrant:
        image: qdrant/qdrant:latest
        env:
          QDRANT__SERVICE__GRPC_PORT: 6334
          QDRANT__SERVICE__HTTP_PORT: 6333
          QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS: 4
          QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS: 2
          QDRANT__COLLECTION__DEFAULT_REPLICATION_FACTOR: 1
          QDRANT__COLLECTION__DEFAULT_WRITE_CONSISTENCY_FACTOR: 1
        ports:
          - 6333:6333
          - 6334:6334
      gai-smb-test:
        image: ${{ needs.check-smb-test-image.outputs.image_tag }}
        credentials:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        ports:
          - 445:445
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.15.4
          run_install: true
      - name: Run database migrations
        run: pnpm --filter @george-ai/app-domain prisma:migrate
      - name: Run Tests
        run: pnpm run test
        env:
          SMB_TEST_HOST: localhost
