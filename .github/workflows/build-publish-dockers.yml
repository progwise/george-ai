name: Build and publish Docker images

on:
  # Only publish Docker images after E2E tests pass on main
  # (E2E tests depend on basic checks, so this ensures all quality checks passed)
  workflow_run:
    workflows:
      - 'E2E Tests'
    types:
      - completed
    branches:
      - main
  # Allow manual triggers and version tags
  push:
    tags:
      - v*
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  REGISTRY_PATH: ghcr.io/progwise/george-ai

jobs:
  # Job 1: Safety check - Only publish if prerequisite workflows succeeded
  check-prerequisites:
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Check workflow trigger
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "Triggered workflow: ${{ github.event.workflow_run.name }}"
            echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
            if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
              echo "❌ Prerequisite workflow did not succeed. Stopping Docker image publishing."
              exit 1
            fi
            echo "✅ Prerequisite workflow succeeded. Proceeding with Docker image publishing."
          else
            echo "✅ Manual trigger or version tag. Proceeding with Docker image publishing."
          fi

  # Job 2: Calculate content-based hashes for each app
  calculate-hashes:
    needs: check-prerequisites
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      backend_hash: ${{ steps.hash.outputs.backend }}
      webapp_hash: ${{ steps.hash.outputs.webapp }}
      webcrawler_hash: ${{ steps.hash.outputs.webcrawler }}
      web_hash: ${{ steps.hash.outputs.web }}
      smb_crawler_hash: ${{ steps.hash.outputs.smb_crawler }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate content hashes
        id: hash
        run: |
          echo "Calculating content-based hashes for each app..."

          # Backend hash (depends on backend code + all packages)
          BACKEND_HASH=$(find apps/georgeai-backend packages pnpm-lock.yaml -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          BACKEND_HASH_SHORT="${BACKEND_HASH:0:12}"
          echo "backend=${BACKEND_HASH_SHORT}" >> $GITHUB_OUTPUT
          echo "Backend hash: ${BACKEND_HASH_SHORT}"

          # Webapp hash (depends on webapp code + web-utils package)
          WEBAPP_HASH=$(find apps/georgeai-webapp packages/web-utils pnpm-lock.yaml -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          WEBAPP_HASH_SHORT="${WEBAPP_HASH:0:12}"
          echo "webapp=${WEBAPP_HASH_SHORT}" >> $GITHUB_OUTPUT
          echo "Webapp hash: ${WEBAPP_HASH_SHORT}"

          # Webcrawler hash (depends on webcrawler code only)
          WEBCRAWLER_HASH=$(find apps/webcrawler pnpm-lock.yaml -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          WEBCRAWLER_HASH_SHORT="${WEBCRAWLER_HASH:0:12}"
          echo "webcrawler=${WEBCRAWLER_HASH_SHORT}" >> $GITHUB_OUTPUT
          echo "Webcrawler hash: ${WEBCRAWLER_HASH_SHORT}"

          # Web hash (depends on web code only)
          WEB_HASH=$(find apps/georgeai-web pnpm-lock.yaml -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          WEB_HASH_SHORT="${WEB_HASH:0:12}"
          echo "web=${WEB_HASH_SHORT}" >> $GITHUB_OUTPUT
          echo "Web hash: ${WEB_HASH_SHORT}"

          # SMB Crawler hash (depends on smb-crawler service + smb-crawler package + smb2-client package)
          SMB_CRAWLER_HASH=$(find services/smb-crawler-service packages/smb-crawler packages/smb2-client pnpm-lock.yaml -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          SMB_CRAWLER_HASH_SHORT="${SMB_CRAWLER_HASH:0:12}"
          echo "smb_crawler=${SMB_CRAWLER_HASH_SHORT}" >> $GITHUB_OUTPUT
          echo "SMB Crawler hash: ${SMB_CRAWLER_HASH_SHORT}"

  # Job 3: Check which images need building
  check-images:
    needs: calculate-hashes
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: read
      packages: read
    outputs:
      build_backend: ${{ steps.check.outputs.build_backend }}
      build_webapp: ${{ steps.check.outputs.build_webapp }}
      build_webcrawler: ${{ steps.check.outputs.build_webcrawler }}
      build_web: ${{ steps.check.outputs.build_web }}
      build_smb_crawler: ${{ steps.check.outputs.build_smb_crawler }}

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check which images need building
        id: check
        env:
          BACKEND_HASH: ${{ needs.calculate-hashes.outputs.backend_hash }}
          WEBAPP_HASH: ${{ needs.calculate-hashes.outputs.webapp_hash }}
          WEBCRAWLER_HASH: ${{ needs.calculate-hashes.outputs.webcrawler_hash }}
          WEB_HASH: ${{ needs.calculate-hashes.outputs.web_hash }}
          SMB_CRAWLER_HASH: ${{ needs.calculate-hashes.outputs.smb_crawler_hash }}
        run: |
          echo "Checking which images need to be built..."

          # Check backend
          BACKEND_TAG="${{ env.REGISTRY_PATH }}/backend:${BACKEND_HASH}"
          if docker manifest inspect "${BACKEND_TAG}" > /dev/null 2>&1; then
            echo "✓ Backend image exists (${BACKEND_HASH})"
            echo "build_backend=false" >> $GITHUB_OUTPUT
          else
            echo "✗ Backend image needs building (${BACKEND_HASH})"
            echo "build_backend=true" >> $GITHUB_OUTPUT
          fi

          # Check webapp
          WEBAPP_TAG="${{ env.REGISTRY_PATH }}/webapp:${WEBAPP_HASH}"
          if docker manifest inspect "${WEBAPP_TAG}" > /dev/null 2>&1; then
            echo "✓ Webapp image exists (${WEBAPP_HASH})"
            echo "build_webapp=false" >> $GITHUB_OUTPUT
          else
            echo "✗ Webapp image needs building (${WEBAPP_HASH})"
            echo "build_webapp=true" >> $GITHUB_OUTPUT
          fi

          # Check webcrawler
          WEBCRAWLER_TAG="${{ env.REGISTRY_PATH }}/webcrawler:${WEBCRAWLER_HASH}"
          if docker manifest inspect "${WEBCRAWLER_TAG}" > /dev/null 2>&1; then
            echo "✓ Webcrawler image exists (${WEBCRAWLER_HASH})"
            echo "build_webcrawler=false" >> $GITHUB_OUTPUT
          else
            echo "✗ Webcrawler image needs building (${WEBCRAWLER_HASH})"
            echo "build_webcrawler=true" >> $GITHUB_OUTPUT
          fi

          # Check web
          WEB_TAG="${{ env.REGISTRY_PATH }}/web:${WEB_HASH}"
          if docker manifest inspect "${WEB_TAG}" > /dev/null 2>&1; then
            echo "✓ Web image exists (${WEB_HASH})"
            echo "build_web=false" >> $GITHUB_OUTPUT
          else
            echo "✗ Web image needs building (${WEB_HASH})"
            echo "build_web=true" >> $GITHUB_OUTPUT
          fi

          # Check smb-crawler
          SMB_CRAWLER_TAG="${{ env.REGISTRY_PATH }}/smb-crawler:${SMB_CRAWLER_HASH}"
          if docker manifest inspect "${SMB_CRAWLER_TAG}" > /dev/null 2>&1; then
            echo "✓ SMB Crawler image exists (${SMB_CRAWLER_HASH})"
            echo "build_smb_crawler=false" >> $GITHUB_OUTPUT
          else
            echo "✗ SMB Crawler image needs building (${SMB_CRAWLER_HASH})"
            echo "build_smb_crawler=true" >> $GITHUB_OUTPUT
          fi

  # Job 4: Build and publish Docker images (matrix strategy)
  build-and-publish:
    needs: [calculate-hashes, check-images]
    if: needs.check-images.outputs.build_backend == 'true' || needs.check-images.outputs.build_webapp == 'true' || needs.check-images.outputs.build_webcrawler == 'true' || needs.check-images.outputs.build_web == 'true' || needs.check-images.outputs.build_smb_crawler == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    strategy:
      matrix:
        include:
          - name: backend
            dockerfile: apps/georgeai-backend/Dockerfile
            build: ${{ needs.check-images.outputs.build_backend }}
            hash: ${{ needs.calculate-hashes.outputs.backend_hash }}
          - name: webapp
            dockerfile: apps/georgeai-webapp/Dockerfile
            build: ${{ needs.check-images.outputs.build_webapp }}
            hash: ${{ needs.calculate-hashes.outputs.webapp_hash }}
          - name: webcrawler
            dockerfile: apps/webcrawler/Dockerfile
            build: ${{ needs.check-images.outputs.build_webcrawler }}
            hash: ${{ needs.calculate-hashes.outputs.webcrawler_hash }}
          - name: web
            dockerfile: apps/georgeai-web/Dockerfile
            build: ${{ needs.check-images.outputs.build_web }}
            hash: ${{ needs.calculate-hashes.outputs.web_hash }}
          - name: smb-crawler
            dockerfile: services/smb-crawler-service/Dockerfile
            build: ${{ needs.check-images.outputs.build_smb_crawler }}
            hash: ${{ needs.calculate-hashes.outputs.smb_crawler_hash }}

    steps:
      - name: Checkout repository
        if: matrix.build == 'true'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: matrix.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        if: matrix.build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for ${{ matrix.name }}
        if: matrix.build == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_PATH }}/${{ matrix.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ matrix.hash }}

      - name: Build and push ${{ matrix.name }}
        if: matrix.build == 'true'
        id: push
        uses: docker/build-push-action@v6
        with:
          file: ${{ matrix.dockerfile }}
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            ${{ steps.meta.outputs.labels }}
            org.opencontainers.image.documentation=https://github.com/progwise/george-ai/blob/main/CHANGELOG.md
          build-args: |
            GIT_COMMIT_SHA=${{ github.sha }}
            PUBLIC_DISCORD_INVITE_URL=https://discord.gg/GbQFKb2MNJ
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}

      - name: Skip ${{ matrix.name }} build
        if: matrix.build != 'true'
        run: echo "⏭️ Skipping ${{ matrix.name }} - image already exists with hash ${{ matrix.hash }}"
