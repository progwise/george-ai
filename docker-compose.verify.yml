version: '3.8'

services:
  # Backend server - connects to devcontainer services
  gai-verify-backend:
    build:
      context: .
      dockerfile: apps/georgeai-backend/Dockerfile
      args:
        GIT_COMMIT_SHA: ${GIT_COMMIT_SHA:-local-docker}
    container_name: gai-verify-backend
    restart: unless-stopped
    networks:
      - default
      - george-ai_devcontainer_default
    environment:
      BACKEND_PUBLIC_URL: http://localhost:3004
      # Connect to devcontainer database (via container name, not port)
      DATABASE_URL: postgresql://chatweb:password@gai-chatweb-db:5432/chatweb?schema=public
      # Connect to devcontainer typesense (via container name)
      TYPESENSE_API_HOST: gai-typesense
      TYPESENSE_API_PORT: 8108
      TYPESENSE_API_PROTOCOL: http
      TYPESENSE_API_KEY: xyz
      GRAPHQL_API_KEY: TestKey
      UPLOADS_PATH: ./.uploads
      # Connect to devcontainer keycloak (via container name)
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-george-ai}
      KEYCLOAK_URL: http://localhost:8180
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-george-ai-web}
      GOOGLE_DRIVE_CLIENT_ID: ${GOOGLE_DRIVE_CLIENT_ID:-}
      GOOGLE_DRIVE_CLIENT_SECRET: ${GOOGLE_DRIVE_CLIENT_SECRET:-}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY:-}
      OLLAMA_VRAM_GB: ${OLLAMA_VRAM_GB:-16}
      AUTOSTART_ENRICHMENT_WORKER: ${AUTOSTART_ENRICHMENT_WORKER:-false}
      AUTOSTART_CONTENT_PROCESSING_WORKER: ${AUTOSTART_CONTENT_PROCESSING_WORKER:-false}
    ports:
      - '3004:3003'
    volumes:
      - ./apps/georgeai-backend/.uploads:/app/.uploads

  # Frontend web application - connects to verify backend and devcontainer keycloak
  gai-verify-webapp:
    build:
      context: .
      dockerfile: apps/georgeai-webapp/Dockerfile
      args:
        GIT_COMMIT_SHA: ${GIT_COMMIT_SHA:-local-docker}
    container_name: gai-verify-frontend
    restart: unless-stopped
    environment:
      # Runtime configuration
      BACKEND_URL: http://gai-verify-backend:3003
      BACKEND_PUBLIC_URL: http://localhost:3004
      KEYCLOAK_REDIRECT_URL: http://localhost:3002
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-george-ai}
      KEYCLOAK_URL: http://localhost:8180
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-george-ai-web}
      PUBLIC_APP_URL: http://localhost:3002
      GIT_COMMIT_SHA: ${GIT_COMMIT_SHA:-local-docker}
    networks:
      - default
      - george-ai_devcontainer_default
    ports:
      - '3002:3000'
    depends_on:
      gai-verify-backend:
        condition: service_healthy

  # Marketing website - public website at george-ai.net
  gai-verify-web:
    build:
      context: .
      dockerfile: apps/georgeai-web/Dockerfile
      args:
        GIT_COMMIT_SHA: ${GIT_COMMIT_SHA:-local-docker}
    container_name: gai-verify-web
    restart: unless-stopped
    environment:
      HOST: 0.0.0.0
      PORT: 4321
      GIT_COMMIT_SHA: ${GIT_COMMIT_SHA:-local-docker}
      # SMTP for contact form (optional) - source .env to use these values
      SMTP_HOSTNAME: ${SMTP_HOSTNAME:-}
      SMTP_PORT: ${SMTP_PORT:-}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
    networks:
      - default
    ports:
      - '3005:4321'

  # Webcrawler - Python-based web crawler service
  gai-verify-webcrawler:
    build:
      context: .
      dockerfile: apps/webcrawler/Dockerfile
      args:
        GIT_COMMIT_SHA: ${GIT_COMMIT_SHA:-local-docker}
    container_name: gai-verify-webcrawler
    restart: unless-stopped
    networks:
      - default
    ports:
      - '11246:11245'

networks:
  george-ai_devcontainer_default:
    external: true
