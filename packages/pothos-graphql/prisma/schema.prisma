// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
  previewFeatures = []
  output          = "../node_modules/@george-ai/prismaClient"
}

generator pothos {
  provider = "prisma-pothos-types"
  output   = "../node_modules/.pothos/plugin-prisma/generated.ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AiAssistantType {
  CHATBOT
  DOCUMENT_GENERATOR
}

enum AiLibraryType {
  GOOGLE_DRIVE
  POCKETBASE
}

model User {
  id                         String                      @id @default(cuid())
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  lastLogin                  DateTime?
  email                      String                      @unique
  username                   String                      @unique
  name                       String?
  given_name                 String?
  family_name                String?
  aiAssistants               AiAssistant[]
  aiLibraries                AiLibrary[]
  conversationParticipations AiConversationParticipant[]
}

model AiAssistant {
  id                        String                      @id @default(cuid())
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  name                      String
  description               String?
  url                       String?
  icon                      String?
  owner                     User                        @relation(fields: [ownerId], references: [id])
  ownerId                   String
  aiAssistantType           AiAssistantType
  usages                    AiLibraryUsage[]
  AiConversationParticipant AiConversationParticipant[]
}

model AiLibrary {
  id            String           @id @default(cuid())
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  name          String
  description   String?
  url           String?
  apiToken      String?
  lastProcessed DateTime?
  owner         User             @relation(fields: [ownerId], references: [id])
  ownerId       String
  isPublic      Boolean          @default(true)
  aiLibraryType AiLibraryType
  usages        AiLibraryUsage[]
  files         AiLibraryFile[]
}

model AiLibraryUsage {
  id            String      @id @default(cuid())
  createdAt     DateTime    @default(now())
  aiAssistant   AiAssistant @relation(fields: [aiAssistantId], references: [id], onDelete: Cascade)
  aiAssistantId String
  aiLibrary     AiLibrary   @relation(fields: [aiLibraryId], references: [id], onDelete: Cascade)
  aiLibraryId   String
}

model AiLibraryFile {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  aiLibrary   AiLibrary @relation(fields: [aiLibraryId], references: [id])
  aiLibraryId String
  name        String
  originUri   String?
  mimeType    String
  size        Int?
  chunks      Int?
  uploadedAt  DateTime?
  processedAt DateTime?
}

model AiConversation {
  id           String                      @id @default(cuid())
  createdAt    DateTime                    @default(now())
  updatedAt    DateTime                    @updatedAt
  messages     AiConversationMessage[]
  participants AiConversationParticipant[]
}

model AiConversationParticipant {
  id                    String                  @id @default(cuid())
  createdAt             DateTime                @default(now())
  aiConversation        AiConversation          @relation(fields: [aiConversationId], references: [id])
  aiConversationId      String
  user                  User?                   @relation(fields: [userId], references: [id])
  userId                String?
  assistant             AiAssistant?            @relation(fields: [assistantId], references: [id])
  assistantId           String?
  AiConversationMessage AiConversationMessage[]
}

model AiConversationMessage {
  id               String                    @id @default(cuid())
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  sender           AiConversationParticipant @relation(fields: [senderId], references: [id])
  senderId         String
  content          String
  AiConversation   AiConversation            @relation(fields: [aiConversationId], references: [id])
  aiConversationId String
}
