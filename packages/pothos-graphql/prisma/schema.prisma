// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
  previewFeatures = []
  output          = "../node_modules/@george-ai/prismaClient"
}

generator pothos {
  provider = "prisma-pothos-types"
  output   = "../node_modules/.pothos/plugin-prisma/generated.ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                      @id @default(cuid())
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  lastLogin                  DateTime?
  email                      String                      @unique
  username                   String                      @unique
  name                       String?
  given_name                 String?
  family_name                String?
  assistants                 AiAssistant[]
  libraries                  AiLibrary[]
  conversationParticipations AiConversationParticipant[]
  profile                    UserProfile?
  conversations              AiConversation[]
}

model UserProfile {
  id               String    @id @default(cuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  expiresAt        DateTime?
  email            String
  firstName        String?
  lastName         String?
  freeMessages     Int       @default(20)
  freeStorage      Int       @default(100000)
  business         String?
  position         String?
  user             User      @relation(fields: [userId], references: [id])
  userId           String    @unique
  confirmationDate DateTime?
}

model AiAssistant {
  id                         String                      @id @default(cuid())
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  name                       String
  description                String?
  url                        String?
  iconUrl                    String?
  owner                      User                        @relation(fields: [ownerId], references: [id])
  ownerId                    String
  usages                     AiLibraryUsage[]
  conversationParticipations AiConversationParticipant[]
  languageModel              String?                     @default("OpenAI")
  baseCases                  AiAssistantBaseCase[]
}

model AiAssistantBaseCase {
  id          String      @id @default(cuid())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  assistant   AiAssistant @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  sequence    Int
  assistantId String
  condition   String?
  instruction String?
}

model AiLibrary {
  id            String             @id @default(cuid())
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  name          String
  description   String?
  url           String?
  apiToken      String?
  lastProcessed DateTime?
  owner         User               @relation(fields: [ownerId], references: [id])
  ownerId       String
  isPublic      Boolean            @default(true)
  usages        AiLibraryUsage[]
  files         AiLibraryFile[]
  crawlers      AiLibraryCrawler[]
}

model AiLibraryUsage {
  id          String      @id @default(cuid())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt
  assistant   AiAssistant @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  assistantId String
  library     AiLibrary   @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  libraryId   String
  usedFor     String?

  @@unique([assistantId, libraryId])
}

model AiLibraryFile {
  id                     String    @id @default(cuid())
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  library                AiLibrary @relation(fields: [libraryId], references: [id])
  libraryId              String
  name                   String
  originUri              String?
  mimeType               String
  size                   Int?
  chunks                 Int?
  uploadedAt             DateTime?
  processedAt            DateTime?
  dropError              String?
  processingStartedAt    DateTime?
  processingEndedAt      DateTime?
  processingErrorAt      DateTime?
  processingErrorMessage String?
}

model AiLibraryCrawler {
  id        String    @id @default(cuid())
  url       String
  libraryId String
  lastRun   DateTime?
  maxDepth  Int
  maxPages  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  library AiLibrary @relation(fields: [libraryId], references: [id])
}

model AiConversation {
  id           String                      @id @default(cuid())
  createdAt    DateTime                    @default(now())
  updatedAt    DateTime                    @updatedAt
  messages     AiConversationMessage[]
  participants AiConversationParticipant[]
  owner        User                        @relation(fields: [ownerId], references: [id])
  ownerId      String
}

model AiConversationParticipant {
  id                  String                  @id @default(cuid())
  createdAt           DateTime                @default(now())
  conversation        AiConversation          @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId      String
  user                User?                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String?
  assistant           AiAssistant?            @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  assistantId         String?
  conversationMessage AiConversationMessage[]
}

model AiConversationMessage {
  id             String                    @id @default(cuid())
  sequenceNumber BigInt                    @default(autoincrement())
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  sender         AiConversationParticipant @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId       String
  content        String
  source         String?
  hidden         Boolean                   @default(false)
  conversation   AiConversation            @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
}
